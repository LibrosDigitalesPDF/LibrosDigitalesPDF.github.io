<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Pro - Biblioteca</title>
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --blue: #3498db; --red: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 650px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; }
        h1 { text-align: center; color: var(--primary); }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.2rem; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 5px; }
        button:disabled { background: #ccc !important; }
        .btn-green { background: var(--green); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .preview-img { width: 80px; height: 110px; object-fit: cover; display: none; margin: 10px auto; border-radius: 5px; border: 1px solid #ddd; }
        .status { text-align: center; font-weight: bold; color: var(--blue); margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Panel de Administración</h1>

    <div class="card" style="border-left: 5px solid var(--blue);">
        <h2>+ Registrar Nuevo Autor</h2>
        <input type="text" id="nombreNuevoAutor" placeholder="Nombre completo del Autor">
        <label>Foto del Autor:</label>
        <input type="file" id="fotoAutor" accept="image/*">
        <img id="prevAutor" class="preview-img">
        <button onclick="guardarAutor(this)" class="btn-blue">REGISTRAR AUTOR</button>
    </div>

    <div class="card" style="border-left: 5px solid var(--green);">
        <h2>+ Subir Nuevo Libro</h2>
        <input type="text" id="tituloLibro" placeholder="Título del Libro">
        <select id="autorSelect"><option value="">Cargando autores...</option></select>
        <input type="text" id="generoLibro" placeholder="Género">
        <input type="number" id="paginasLibro" placeholder="Cantidad de Páginas">
        <label>Portada del Libro:</label>
        <input type="file" id="fotoLibro" accept="image/*">
        <img id="prevLibro" class="preview-img">
        <button onclick="guardarLibro(this)" class="btn-green">GUARDAR LIBRO</button>
    </div>

    <div class="card" style="border-left: 5px solid var(--blue);">
        <h2>+ Crear Nuevo Pack</h2>
        <input type="text" id="nombrePack" placeholder="Nombre del Pack">
        <label>Imagen del Pack:</label>
        <input type="file" id="fotoPack" accept="image/*">
        <img id="prevPack" class="preview-img">
        <button onclick="guardarPack(this)" class="btn-blue">CREAR PACK</button>
    </div>

    <div class="card">
        <h2>+ Vincular Libro a Pack</h2>
        <select id="selectPack"><option value="">Seleccionar Pack</option></select>
        <select id="selectLibro"><option value="">Seleccionar Libro</option></select>
        <button onclick="vincular(this)" class="btn-blue">AÑADIR AL PACK</button>
    </div>

    <div class="card" style="border-top: 5px solid var(--red);">
        <h2 style="color: var(--red);">Eliminar Contenido</h2>
        <select id="tipoEliminar">
            <option value="libros">Libro</option>
            <option value="packs">Pack</option>
            <option value="autores">Autor</option>
        </select>
        <select id="listaEliminar"><option value="">Selecciona elemento...</option></select>
        <button onclick="eliminarElemento(this)" class="btn-red">ELIMINAR PERMANENTEMENTE</button>
    </div>

    <div id="globalStatus" class="status">Procesando... por favor espera.</div>
</div>

<script>
    // --- SEGURIDAD ---
    const pass = prompt("Ingresa la clave de administrador:");
    if (pass !== "Serepasan7") { 
        alert("Acceso denegado");
        document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>Acceso Restringido</h1>";
        throw new Error("No autorizado");
    }

    const API_URL = "https://script.google.com/macros/s/AKfycbxR9owUKbqXlUj3-hDYZKnFSxHqr1ZHl42z30kWREzJvFhHYwFShP1up5RPm8tuG_RC/exec"; 

    async function actualizarListas() {
        const res = await fetch(API_URL);
        const data = await res.json();
        const fill = (id, list, kId, kName) => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">Seleccionar...</option>';
            list.sort((a,b) => String(a[kName]).localeCompare(String(b[kName])))
                .forEach(i => el.innerHTML += `<option value="${i[kId]}">${i[kName] || i.titulo || i.nombre}</option>`);
        };
        fill('autorSelect', data.autores, 'autor_id', 'nombre');
        fill('selectPack', data.packs, 'pack_id', 'nombre');
        fill('selectLibro', data.libros, 'libro_id', 'titulo');
        const tipo = document.getElementById('tipoEliminar').value;
        fill('listaEliminar', data[tipo], (tipo === 'libros' ? 'libro_id' : (tipo === 'packs' ? 'pack_id' : 'autor_id')), (tipo === 'libros' ? 'titulo' : 'nombre'));
    }

    document.getElementById('tipoEliminar').onchange = actualizarListas;

    async function enviar(payload, btn) {
        btn.disabled = true;
        document.getElementById('globalStatus').style.display = 'block';
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Operación exitosa");
        location.reload();
    }

    function procesarConFoto(fileInput, extraData, btn) {
        const file = fileInput.files[0];
        if(!file) return alert("Falta seleccionar la imagen");
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            enviar({
                ...extraData,
                imagenBase64: reader.result,
                mimeType: file.type,
                nombreArchivo: file.name
            }, btn);
        };
    }

    function guardarAutor(btn) {
        procesarConFoto(document.getElementById('fotoAutor'), {
            accion: "nuevo_autor",
            nombre: document.getElementById('nombreNuevoAutor').value
        }, btn);
    }

    function guardarLibro(btn) {
        procesarConFoto(document.getElementById('fotoLibro'), {
            accion: "nuevo_libro",
            titulo: document.getElementById('tituloLibro').value,
            autorId: document.getElementById('autorSelect').value,
            genero: document.getElementById('generoLibro').value,
            paginas: document.getElementById('paginasLibro').value
        }, btn);
    }

    function guardarPack(btn) {
        procesarConFoto(document.getElementById('fotoPack'), {
            accion: "nuevo_pack",
            nombre: document.getElementById('nombrePack').value
        }, btn);
    }

    function vincular(btn) {
        enviar({ accion: "asociar_pack", packId: document.getElementById('selectPack').value, libroId: document.getElementById('selectLibro').value }, btn);
    }

    function eliminarElemento(btn) {
        const id = document.getElementById('listaEliminar').value;
        const hoja = document.getElementById('tipoEliminar').value;
        if(!id || !confirm("¿Borrar permanentemente?")) return;
        enviar({ accion: "eliminar", hoja, id }, btn);
    }

    const setupPrev = (input, imgId) => {
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => { 
                const img = document.getElementById(imgId);
                img.src = ev.target.result; 
                img.style.display = 'block'; 
            };
            reader.readAsDataURL(e.target.files[0]);
        };
    };
    setupPrev(document.getElementById('fotoAutor'), 'prevAutor');
    setupPrev(document.getElementById('fotoLibro'), 'prevLibro');
    setupPrev(document.getElementById('fotoPack'), 'prevPack');

    actualizarListas();
</script>
</body>
</html>
